require 'rails_helper'
require 'transform_xml'



describe TransformXML, :type => :helper do
  describe "#add_display_elements" do
    it "adds agentSet displays with commas between agents and semi-colons between agentSets" do

      xml_with_agentSet = "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<vra:vra\n    xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n    xmlns:fn=\"http://www.w3.org/2005/xpath-functions\"\n    xmlns:vra=\"http://www.vraweb.org/vracore4.htm\"\n    xmlns:rdf=\"http://www.w3.org/1999/02/22-rdf-syntax-ns#\" xsi:schemaLocation=\"http://www.vraweb.org/vracore4.htm http://www.loc.gov/standards/vracore/vra-strict.xsd\">\n    <vra:image>\n        <!--Agents-->\n        <vra:agentSet>\n            <vra:agent>\n                <vra:name type=\"personal\" vocab=\"lcnaf\">agent Uno</vra:name>\n                <vra:attribution>att uno</vra:attribution>\n                <vra:role vocab=\"RDA\">role uno</vra:role>\n            </vra:agent>\n            <vra:agent>\n                <vra:name>Agent duo</vra:name>\n                <vra:attribution>att duo</vra:attribution>\n                <vra:role>role duo</vra:role>\n            </vra:agent>\n        </vra:agentSet>\n        <!--Cultural Context-->\n        <vra:culturalContextSet>\n            <vra:culturalContext/>\n        </vra:culturalContextSet>\n        <!--Dates-->\n        <vra:dateSet>\n            <vra:display/>\n            <vra:date type=\"creation\">\n                <vra:earliestDate>present</vra:earliestDate>\n            </vra:date>\n        </vra:dateSet></vra:image>\n    </vra:vra>"

      xml_with_agentSet_display = "<vra:agentSet><vra:display>agent Uno, att uno, role uno ; Agent duo, att duo, role duo</vra:display>"

      expect(TransformXML.add_display_elements(xml_with_agentSet)).to include(xml_with_agentSet_display)
    end

    it "adds locationSet display with source attributes prepended with a colon" do

      xml_with_locationSet = "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<vra:vra\n    xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n    xmlns:fn=\"http://www.w3.org/2005/xpath-functions\"\n    xmlns:vra=\"http://www.vraweb.org/vracore4.htm\"\n    xmlns:rdf=\"http://www.w3.org/1999/02/22-rdf-syntax-ns#\" xsi:schemaLocation=\"http://www.vraweb.org/vracore4.htm http://www.loc.gov/standards/vracore/vra-strict.xsd\">\n    <vra:image><!--Location--><vra:locationSet><vra:location type=\"creation\"><vra:name type=\"geographic\">London</vra:name></vra:location><vra:location type=\"repository\"><vra:name type=\"geographic\">Posters from the Herskovits Library</vra:name></vra:location><vra:location source=\"MARC 590\"><vra:refid type=\"shelfList\">Object no. SA.5.</vra:refid></vra:location><vra:location><vra:refid source=\"DIL\"/><vra:refid source=\"Voyager\">1234567</vra:refid><vra:refid source=\"Accession\">7654321</vra:refid></vra:location></vra:locationSet>\n        <!--Dates-->\n        <vra:dateSet>\n            <vra:display/>\n            <vra:date type=\"creation\">\n                <vra:earliestDate>present</vra:earliestDate>\n            </vra:date>\n        </vra:dateSet></vra:image>\n    </vra:vra>"

      xml_with_locationSet_display = "<vra:locationSet><vra:display>London ; Posters from the Herskovits Library ; Object no. SA.5. ; Voyager:1234567 ; Accession:7654321</vra:display>"

      expect(TransformXML.add_display_elements(xml_with_locationSet)).to include(xml_with_locationSet_display)
    end
  end

  describe "#get_accession_nbr" do
    it "extracts the accession number from the vra_xml" do 
      xml_with_accession = "<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<vra:vra\n    xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n    xmlns:fn=\"http://www.w3.org/2005/xpath-functions\"\n    xmlns:vra=\"http://www.vraweb.org/vracore4.htm\"\n    xmlns:rdf=\"http://www.w3.org/1999/02/22-rdf-syntax-ns#\" xsi:schemaLocation=\"http://www.vraweb.org/vracore4.htm http://www.loc.gov/standards/vracore/vra-strict.xsd\">\n    <vra:image>\n        <!--Agents-->\n        <vra:agentSet>\n            <vra:agent>\n                <vra:name type=\"personal\" vocab=\"lcnaf\"/>\n                <vra:attribution/>\n                <vra:role vocab=\"RDA\"/>\n            </vra:agent>\n        </vra:agentSet>\n        <!--Cultural Context-->\n        <vra:culturalContextSet>\n            <vra:culturalContext/>\n        </vra:culturalContextSet>\n        <!--Dates-->\n        <vra:dateSet>\n            <vra:display/>\n            <vra:date type=\"creation\">\n                <vra:earliestDate>2015</vra:earliestDate>\n            </vra:date>\n        </vra:dateSet>\n        <!--Description-->\n        <vra:descriptionSet>\n            <vra:description/>\n        </vra:descriptionSet>\n        <!--Inscription-->\n        <vra:inscriptionSet>\n            <vra:inscription>\n                <vra:text/>\n            </vra:inscription>\n        </vra:inscriptionSet>\n        <!--Location-->\n        <vra:locationSet>\n            <vra:location type=\"creation\">\n                <vra:name type=\"geographic\"/>\n            </vra:location>\n            <vra:location type=\"repository\">\n                <vra:name type=\"geographic\"/>\n            </vra:location>\n            <vra:location>\n                <vra:refid source=\"DIL\"/>\n                <vra:refid source=\"Accession\">1234</vra:refid>\n            </vra:location>\n        </vra:locationSet>\n        <!--Materials-->\n        <vra:materialSet>\n            <vra:material/>\n        </vra:materialSet>\n        <!--Measurements-->\n        <vra:measurementsSet>\n            <vra:measurements/>\n        </vra:measurementsSet>\n        <!--Relation-->\n        <vra:relationSet>\n            <vra:relation pref=\"true\" type=\"imageOf\" relids=\"\"/>\n        </vra:relationSet>\n        <!--Rights-->\n        <vra:rightsSet>\n            <vra:rights>\n                <vra:rightsHolder/>\n                <vra:text/>\n            </vra:rights>\n        </vra:rightsSet>\n        <!-- Source -->\n        <vra:sourceSet>\n            <vra:source/>\n        </vra:sourceSet>\n        <!--Style Period-->\n        <vra:stylePeriodSet>\n            <vra:stylePeriod/>\n        </vra:stylePeriodSet>\n        <!--Subjects-->\n        <vra:subjectSet>\n            <vra:display/>\n            <vra:subject>\n                <vra:term type=\"geographicPlace\" vocab=\"lcnaf\"/>\n            </vra:subject>\n            <vra:subject>\n                <vra:term type=\"personalName\" vocab=\"lcnaf\"/>\n            </vra:subject>\n            <vra:subject>\n                <vra:term type=\"personalName\" vocab=\"lcnaf\"/>\n            </vra:subject>\n            <vra:subject>\n                <vra:term type=\"otherTopic\"/>\n            </vra:subject>\n            <vra:subject>\n                <vra:term type=\"descriptiveTopic\" vocab=\"lcsh\"/>\n            </vra:subject>\n        </vra:subjectSet>\n        <!--Technique-->\n        <vra:techniqueSet>\n            <vra:technique/>\n        </vra:techniqueSet>\n        <!--Textref-->\n        <vra:textrefSet>\n            <vra:textref/>\n        </vra:textrefSet>\n        <!-- Titles -->\n        <vra:titleSet>\n            <vra:title pref=\"true\">Testing dupe check</vra:title>\n        </vra:titleSet>\n        <!--Work Type-->\n        <vra:worktypeSet>\n            <vra:worktype/>\n        </vra:worktypeSet>\n    </vra:image>\n    <vra:work/>\n</vra:vra>"
      expect(TransformXML.get_accession_nbr(xml_with_accession)).to eql("1234")
    end  
  end
end